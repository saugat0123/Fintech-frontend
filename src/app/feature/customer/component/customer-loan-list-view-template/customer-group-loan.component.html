<app-spinner *ngIf="spinner" class="d-flex justify-content-center"></app-spinner>
<div class="row">
    <div class="col-md-12">
        <nb-card>
            <ng-container>
                <nb-card-header>Initial, Pending</nb-card-header>
                <nb-card-body>
                    <table *ngIf="!spinner"
                           class="table table-bordered table-hover table-sm sb-small text-center"
                           style="max-height: 400px;overflow-y: auto">
                        <thead>
                        <tr class="sb-bg-dark text-white">
                            <th>S.N</th>
                            <th>Loan Facility</th>
                            <th>Proposed Limit</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created On</th>
                            <th>Collateral Req %</th>
                            <th>Required Collateral</th>
                            <th>File Under</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <ng-container
                                *ngFor="let model of loanHistoriesGroup(loanHistories)?.pending; let i=index">
                            <tr class="cursor">
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{i + 1}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.loanName}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)"
                                    class="text-right pr-1">Rs. {{(model?.proposalProposedLimit | currencyFormatter)
                                || 0}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{loanType[model?.loanType] || model?.loanType}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.documentStatus}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.createdAt | date}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.collateralRequirement}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)"
                                    class="text-right pr-1">
                                    Rs. {{(model?.collateralRequirement * model?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.currentStage?.toUser?.name}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : ''">
                                    <a nbTooltip="change loan"  (click)="changeLoan(model.id,model?.loanId)" *ngIf="!model?.combinedLoans && model?.parentId === null && model?.currentStage?.toUser?.id.toString()===currentUserId && currentUserRoleType === 'MAKER' && isLoaded && !loan[i].loan?.isRemit"><em
                                            class="fa fa-cog"></em></a>&nbsp;
                                    <a nbTooltip="Delete loan" class="text-danger" (click)="deleteLoan(model?.id)" *ngIf="!model?.combinedLoans  && model?.currentStage?.toUser?.id.toString()===currentUserId && (currentUserRoleType === 'MAKER')"><em
                                            class="fa fa-trash"></em></a>&nbsp;
                                    <a nbTooltip="Video KYC"  class="text-danger" *ngIf="isLoaded && loan[i]?.loan?.loanTag === loanTag?.getKeyByValue(loanTag.REMIT_LOAN) &&loan[i]?.loan?.isRemit "  (click)="addVideoKyc(model)">
                                        <em class="fa fa-camera"></em>
                                    </a>&nbsp;
                                    <a nbTooltip="Delete loan" class="text-danger" (click)="deleteLoan(model?.id)" *ngIf="!model?.combinedLoans  && model?.currentStage?.toRole?.roleType.toString()==='MAKER' && (currentUserRoleType === 'ADMIN')"><em
                                            class="fa fa-trash"></em></a>&nbsp;


                                </td>
                            </tr>
                            <ng-container *ngIf="toggleArray[i].toggled">
                                <tr *ngFor="let single of model?.combinedLoans;let i=index"
                                    class="cursor" style="background-color: #cccccc;">
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{'abcdefghijklmnopqrstuvwxyz'.charAt(i)}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.loanName}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                        class="text-right pr-1">Rs. {{(single?.proposalProposedLimit | currencyFormatter)
                                    || 0}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{loanType[single?.loanType]}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.documentStatus}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.createdAt | date}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.collateralRequirement}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                        class="text-right pr-1">
                                        Rs. {{(single?.collateralRequirement * single?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                    <td>

                                        <a nbTooltip="change loan" (click)="changeLoan(single.id,single?.loanId)" *ngIf=" single?.parentId === null && single?.currentStage?.toUser?.id.toString()===currentUserId && currentUserRoleType === 'MAKER'"><em
                                                class="fa fa-cog"></em></a>&nbsp;
                                        <a nbTooltip="Delete loan" class="text-danger" (click)="deleteLoan(single?.id)" *ngIf="single?.currentStage?.toUser?.id.toString()===currentUserId && (currentUserRoleType === 'MAKER')"><em
                                                class="fa fa-trash"></em></a>&nbsp;
                                        <a nbTooltip="Delete loan" class="text-danger" (click)="deleteLoan(single?.id)"  *ngIf="single?.currentStage?.toRole?.roleType.toString()==='MAKER' && (currentUserRoleType === 'ADMIN')"><em
                                                class="fa fa-trash"></em></a>&nbsp;

                                    </td>
                                </tr>
                            </ng-container>
                        </ng-container>
                        <tr class="sb-bg-secondary text-white">
                            <td></td>
                            <td>Total</td>
                            <td class="text-right pr-1">Rs. {{totalInitialPendingProposedAmount |currencyFormatter}}</td>
                            <td colspan="4"></td>
                            <td class="text-right pr-1">
                                Rs. {{totalInitialPendingCollateralAmount|currencyFormatter}}</td>
                        </tr>
                        </tbody>
                    </table>
                </nb-card-body>
            </ng-container>
            <ng-container *ngIf="loanHistoriesGroup(loanHistories)?.approved?.length > 0">
                <nb-card-header>Approved</nb-card-header>
                <nb-card-body>
                    <table *ngIf="!spinner"
                           class="table table-bordered table-hover table-sm sb-small text-center"
                           style="max-height: 400px;overflow-y: auto">
                        <thead>
                        <tr class="sb-bg-dark text-white">
                            <th>S.N</th>
                            <th>Loan Facility</th>
                            <th>Approved Limit</th>
                            <th>Type</th>
                            <th>Created On</th>
                            <th>Collateral Req%</th>
                            <th>Required Collateral</th>
                            <th>Approved Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        <ng-container
                                *ngFor="let model of loanHistoriesGroup(loanHistories).approved; let i=index">
                            <tr class="cursor">
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{i + 1}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.loanName}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)" class="text-right pr-1">
                                    Rs. {{(model?.proposalProposedLimit | currencyFormatter) || 0}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{loanType[model?.loanType] || model?.loanType}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.createdAt | date}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.collateralRequirement}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)" class="text-right pr-1">
                                    Rs. {{(model?.collateralRequirement * model?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)" class="text-left pl-1">{{model?.currentStage?.lastModifiedAt | date}}({{model?.currentStage?.lastModifiedAt | engNepDate : false}})</td>
                            </tr>
                            <ng-container *ngIf="toggleArray[i].toggled">
                                <tr (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                    *ngFor="let single of model?.combinedLoans;let i=index"
                                    class="cursor" style="background-color: #cccccc;">
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">
                                        {{'abcdefghijklmnopqrstuvwxyz'.charAt(i)}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.loanName}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)" class="text-right pr-1">
                                        Rs. {{(single?.proposalProposedLimit | currencyFormatter) || 0}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{loanType[single?.loanType]}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.createdAt | date}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.collateralRequirement}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)" class="text-right pr-1">
                                        Rs. {{(single?.collateralRequirement * single?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                    <td class="text-left pl-1">{{single?.currentStage?.lastModifiedAt | date}}({{single?.currentStage?.lastModifiedAt | engNepDate : false}})</td>
                                </tr>
                            </ng-container>
                        </ng-container>
                        <tr class="sb-bg-secondary text-white">
                            <td></td>
                            <td>Total</td>
                            <td class="text-right pr-2">
                                Rs. {{totalApprovedProposedAmount |currencyFormatter}}</td>
                            <td colspan="3"></td>
                            <td class="text-right pr-1">
                                Rs. {{totalApprovedCollateralAmount |currencyFormatter}}</td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>
                </nb-card-body>
            </ng-container>

            <ng-container *ngIf="loanHistoriesGroup(loanHistories)?.rejected?.length > 0" >
                <nb-card-header>Rejected</nb-card-header>
                <nb-card-body>
                    <table *ngIf="!spinner"
                           class="table table-bordered table-hover table-sm sb-small text-center"
                           style="max-height: 400px;overflow-y: auto">
                        <thead>
                        <tr class="sb-bg-dark text-white">
                            <th>S.N</th>
                            <th>Loan Facility</th>
                            <th>Proposed Limit</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created On</th>
                            <th>Collateral Req %</th>
                            <th>Required Collateral</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <ng-container
                                *ngFor="let model of loanHistoriesGroup(loanHistories)?.rejected; let i=index">
                            <tr class="cursor">
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{i + 1}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.loanName}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)"
                                    class="text-right pr-1">Rs. {{(model?.proposalProposedLimit | currencyFormatter) || 0}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{loanType[model?.loanType] || model?.loanType}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.documentStatus}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.createdAt | date}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.collateralRequirement}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)"
                                    class="text-right pr-1">Rs. {{(model?.collateralRequirement * model?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                <td>
                                    <div *ngIf='((model?.documentStatus.toString() === "REJECTED") && canReInitiateLoan)'>
                                        <button nbButton status="warning" size="tiny"
                                                (click)="onReInitiateClick(onReInitiateLoan, model?.id, model?.customerInfoCustomerName,
                                        model?.loanName, loanType[model?.loanType], model?.branchName, model?.combinedLoans)">
                                            Re-initiate</button>
                                    </div>
                                    <div *ngIf="model.parentId">
                                        <a (click)="renewedOrCloseFrom(model?.id,model?.parentId)"
                                           class="text-success cursor">{{loanType[model.loanType]}} From
                                            <em class="p-1 fa fa-edit"></em></a>
                                    </div>
                                    <div *ngIf='!model.parentId && !((model?.documentStatus.toString() === "REJECTED") && canReInitiateLoan)'>
                                        <p>NA</p>
                                    </div>
                                </td>
                            </tr>
                            <ng-container *ngIf="toggleArray[i].toggled">
                                <tr *ngFor="let single of model?.combinedLoans;let i=index"
                                    class="cursor" style="background-color: #cccccc;">
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{'abcdefghijklmnopqrstuvwxyz'.charAt(i)}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.loanName}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                        class="text-right pr-1">Rs. {{(single?.proposalProposedLimit | currencyFormatter)
                                    || 0}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{loanType[single?.loanType]}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.documentStatus}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.createdAt | date}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.collateralRequirement}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                        class="text-right pr-1">
                                        Rs. {{(single?.collateralRequirement * single?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                </tr>
                            </ng-container>
                        </ng-container>
                        <tr class="sb-bg-secondary text-white">
                            <td></td>
                            <td>Total</td>
                            <td class="text-right pr-1">Rs. {{totalRejectProposedAmount |currencyFormatter}}</td>
                            <td colspan="4"></td>
                            <td class="text-right pr-1">
                                Rs. {{totalRejectCollateralAmount |currencyFormatter}}</td>
                        </tr>
                        </tbody>
                    </table>
                </nb-card-body>
            </ng-container>
            <ng-container *ngIf="loanHistoriesGroup(loanHistories)?.closed?.length > 0">
                <nb-card-header>Closed</nb-card-header>
                <nb-card-body>
                    <table *ngIf="!spinner"
                           class="table table-bordered table-hover table-sm sb-small text-center"
                           style="max-height: 400px;overflow-y: auto">
                        <thead>
                        <tr class="sb-bg-dark text-white">
                            <th>S.N</th>
                            <th>Loan Facility</th>
                            <th>Proposed Limit</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created On</th>
                            <th>Collateral Req %</th>
                            <th>Required Collateral</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        <ng-container
                                *ngFor="let model of loanHistoriesGroup(loanHistories)?.closed; let i=index">
                            <tr class="cursor">
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{i + 1}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.loanName}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)"
                                    class="text-right pr-1">Rs. {{(model?.proposalProposedLimit | currencyFormatter) || 0}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{loanType[model?.loanType] || model?.loanType}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.documentStatus}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.createdAt | date}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)">{{model?.collateralRequirement}}</td>
                                <td (click)="model?.combinedLoans ? toggleArray[i].toggled = !toggleArray[i].toggled : onClick(model?.loanId, model.id,model?.currentStage)"
                                    class="text-right pr-1">
                                    Rs. {{(model?.collateralRequirement * model?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                <td>
                                </td>
                            </tr>
                            <ng-container *ngIf="toggleArray[i].toggled">
                                <tr *ngFor="let single of model?.combinedLoans;let i=index"
                                    class="cursor" style="background-color: #cccccc;">
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{'abcdefghijklmnopqrstuvwxyz'.charAt(i)}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.loanName}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                        class="text-right pr-1">Rs. {{(single?.proposalProposedLimit | currencyFormatter)
                                    || 0}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{loanType[single?.loanType]}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.documentStatus}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.createdAt | date}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)">{{single?.collateralRequirement}}</td>
                                    <td (click)="onClick(single?.loanId, single.id,single?.currentStage)"
                                        class="text-right pr-1">
                                        Rs. {{(single?.collateralRequirement * single?.proposalProposedLimit) / 100 |currencyFormatter}}</td>
                                </tr>
                            </ng-container>
                        </ng-container>
                        <tr class="sb-bg-secondary text-white">
                            <td></td>
                            <td>Total</td>
                            <td class="text-right pr-1">Rs. {{totalClosedProposedAmount |currencyFormatter}}</td>
                            <td colspan="4"></td>
                            <td class="text-right pr-1">
                                Rs. {{totalClosedCollateralAmount |currencyFormatter}}</td>
                        </tr>
                        </tbody>
                    </table>
                </nb-card-body>
                <nb-card-footer>
                </nb-card-footer>
            </ng-container>
        </nb-card>
    </div>
</div>

<ng-template #onReInitiateLoan class="p-0">
    <nb-card class="m-0" [nbSpinner]="reInitiateSpinner">
        <nb-card-header>
            <h5>Are you sure you want to re-initiate this loan?</h5>
        </nb-card-header>
        <nb-card-body>
            <div>Customer:
                <ng-container *ngIf="isCombineLoan; else notCombine">
                    Customer: {{reInitiateLoanCustomerName}} <br>
                    Loan:
                    <span *ngFor="let data of loanConfigData; let clInd = index">
                        {{data?.loanName}}({{data?.loanType}}){{clInd === loanConfigData.length - 1 ? '' : ','}}
                    </span>
                </ng-container>
                <ng-template #notCombine>
                    Customer: {{reInitiateLoanCustomerName}} <br>
                    Loan: {{reInitiateLoanFacilityName}}({{reInitiateLoanType}})
                </ng-template>
            </div>
            <br>
            <label for="comment">Remarks to re-initiate loan:</label>
            <textarea rows="5" #comment id="comment" class="form-control" placeholder="Remarks"></textarea>
        </nb-card-body>
        <nb-card-footer>
            <div class="d-flex justify-content-end">
                <button (click)="reInitiateConfirm(comment?.value)" nbButton status="primary" type="submit">YES</button>
                <button (click)="onClose()" nbButton status="warning" type="button">NO</button>
            </div>
        </nb-card-footer>
    </nb-card>
</ng-template>


<app-overlay-spinner></app-overlay-spinner>

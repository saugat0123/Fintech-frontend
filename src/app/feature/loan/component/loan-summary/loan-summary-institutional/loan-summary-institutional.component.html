<section class="enable-print summary">
    <div id="print-block">
        <div class="summary">
            <ng-container *ngIf="proposalData?.data !== null">
                <app-proposal-summary
                        *ngIf="proposalSummary"
                        [customerAllLoanList]="customerAllLoanList"
                        [proposalData]="proposalData"
                        [loanDataHolder]="loanDataHolder"></app-proposal-summary>
            </ng-container>
            <div *ngIf="isCorporate" class="col-md-12">
                <p><strong class="header text-left">Purpose of Loan </strong></p>
                <ng-container  *ngFor="let loan of customerAllLoanList; let i = index">
                    <ng-container *ngIf="loan?.id" class="summary">
                        <span><strong>{{ loan?.loan?.name }}</strong></span> <br>
                        <ul>
                            <li>
                                <span [innerHTML]="(loan?.proposal?.data | jsonParse)?.purposeOfLoan || 'N/A' | safeHtml"></span>
                            </li>
                        </ul>
                    </ng-container>
                </ng-container>
            </div>
            <!--                release and replacement-->
            <ng-container>
                <hr class="print-line">
                <p><strong class="header">Security Schedule</strong></p>
                <app-security-total-summary [securities]="loanSecurity"
                                            [approvedSec]="approvedSecurity"
                                            [loanHolder]="loanDataHolder?.loanHolder"
                                            [customerAllLoanList]="customerAllLoanList"></app-security-total-summary>
                <!--                    proposed security-->
                <app-security-summary *ngIf="loanSecurity?.length > 0"
                                      [securities]="loanSecurity"
                                      [pending]="true"></app-security-summary>
                <!--                    existing security-->
                <app-security-summary *ngIf="approvedSecurity?.length > 0" [securities]="approvedSecurity"></app-security-summary>

                <app-guarantor-view *ngIf="isCorporate" [customerAllLoanList]="customerAllLoanList"></app-guarantor-view>
                <ng-container>
                    <div class="row">
                        <div class="col-md-12">
                            <p class="sub-header"><strong>Customer Reporting Information</strong></p>
                            <table class="table table-condensed table-bordered table-responsive-md text-center table-sm sb-small">
                                <tr class="sb-bg-gray">
                                    <td>S.N</td>
                                    <td>Description</td>
                                </tr>
                                <tr *ngFor="let reporting of customerReportingInfo; let i = index;">
                                    <td>{{i+1}}</td>
                                    <td>{{reporting?.description}}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </ng-container>


            </ng-container>
            <app-security-schedule [loanDataHolder]="loanDataHolder"></app-security-schedule>
            <!-- Customer Share Security  -->
            <app-customer-share-summary *ngIf="loanDataHolder?.loanHolder?.customerShareBatches && isShareLoan"
                                        [customerShareBatch]="loanDataHolder?.loanHolder?.customerShareBatches">
            </app-customer-share-summary>
           <ng-container>
               <hr class="print-line">
               <p [hidden]="loanCategory === 'INSTITUTION'"><strong class="header">Applicant/Guarantor
                   Profile</strong></p>

               <div class="row">
                   <div class="col-md-12">
                       <app-company-info-summary [approveSheet]="notApprove"
                                                 [companyInfo]="loanDataHolder?.companyInfo"
                                                 [loanDataHolder]="loanDataHolder"></app-company-info-summary>
                       <app-guarantor-view *ngIf="!isCorporate" [customerAllLoanList]="customerAllLoanList"></app-guarantor-view>

                   </div>
               </div>
               <ng-container *ngIf="!fullSettlement">
                   <hr class="print-line">
                   <div class="row  mt-1">
                       <div>
                           <div *ngIf="!isCorporate" class="col-md-12">
                               <p><strong class="header text-left">Purpose of Loan </strong></p>
                               <ng-container  *ngFor="let loan of customerAllLoanList; let i = index">
                                   <ng-container *ngIf="loan?.id" class="summary">
                                       <span><strong>{{ loan?.loan?.name }}</strong></span> <br>
                                       <ul>
                                           <li>
                                               <span [innerHTML]="(loan?.proposal?.data | jsonParse)?.purposeOfLoan || 'N/A' | safeHtml"></span>
                                           </li>
                                       </ul>
                                   </ng-container>
                               </ng-container>
                           </div>
                           <div class="col-md-12" *ngIf="checkedData?.borrowChecked">
                               <hr class="print-line">
                               <p><strong class="header text-left">Borrowing Case: </strong> <span class="text-left"
                                                                                                   style="display: flex"
                                                                                                   [innerHTML]="proposalAllData?.borrowingCase || 'N/A' | safeHtml"></span>
                               </p>
                           </div>
                           <div class="col-md-12" *ngIf="checkedData?.endUseChecked">
                               <hr class="print-line">
                               <p><strong class="header text-left">End Use Of Fund: </strong> <span class="text-left"
                                                                                                    style="display: flex"
                                                                                                    [innerHTML]="proposalAllData?.endUseOfFund || 'N/A' | safeHtml"></span>
                               </p>
                           </div>
                           <div class="col-md-12">
                               <app-cicl-view *ngIf="loanDataHolder?.loanHolder?.cicl"
                                              [ciclValue]="loanDataHolder?.loanHolder?.cicl"
                                              [loanDataHolder]="loanDataHolder"></app-cicl-view>


                               <app-multi-banking-summary *ngIf="loanDataHolder?.loanHolder?.multiBanking && isCorporate"
                                                          [formData]="loanDataHolder?.loanHolder?.multiBanking"></app-multi-banking-summary>

                               <ng-container *ngIf="loanDataHolder?.loanHolder?.customerType === 'INSTITUTION' && smallBusiness; else financials">
                                   <hr class="print-line">
                                   <app-financial-account-information [financialAssessmentData]="loanDataHolder?.loanHolder?.financialAssessmentData"
                                                                      [fromLoan]="false"></app-financial-account-information>
                               </ng-container>
                           </div>
                           <ng-template #financials>
                               <hr class="print-line">
                           <div class="row">
                               <p  *ngIf="loanDataHolder?.loanHolder?.customerType === 'INSTITUTION' && financialSummary"
                                   class="col-md-12 text-left"><strong class="header">Financial</strong></p>
                                   <app-financial-json-parser *ngIf="loanDataHolder?.loanHolder?.customerType === 'INSTITUTION' && financialSummary"
                                                              [summaryOnly]="true" [financialJson]="financial ?  (financial['executiveSummaryData'] | jsonParse) : ''"  [title]="'executiveSummaryData'"></app-financial-json-parser>
                                   <app-financial-json-parser *ngIf="loanDataHolder?.loanHolder?.customerType === 'INSTITUTION'&& financialSummary"
                                                              [summaryOnly]="true" [financialJson]="financial ? (financial['cashFlowData'] | jsonParse) : ''"  [title]="'cashFlowData'"></app-financial-json-parser>
                           </div>
                           </ng-template>
                           <ng-container *ngIf="!smallBusiness">
                               <div class="col-md-12" *ngIf="(loanDataHolder?.loanHolder?.financial?.historicalProjected | jsonParse)?.changeHistorical">
                                   <hr class="print-line">
                                   <p><strong class="header text-left">Justification for Change (Historical): </strong></p>
                                   <div [innerHTML]="(loanDataHolder?.loanHolder?.financial?.historicalProjected | jsonParse)?.changeHistorical || 'N/A' | safeHtml"></div>
                               </div>
                               <div class="col-md-12" *ngIf="(loanDataHolder?.loanHolder?.financial?.historicalProjected | jsonParse)?.changeProjection">
                                   <hr class="print-line">
                                   <p><strong class="header text-left">Justification for Change (Projection)
                                       : </strong>
                                   </p>
                                   <div [innerHTML]="(loanDataHolder?.loanHolder?.financial?.historicalProjected | jsonParse)?.changeProjection || 'N/A' | safeHtml"></div>
                               </div>
                               <div class="col-md-12" *ngIf="(loanDataHolder?.loanHolder?.financial?.historicalProjected | jsonParse)?.remarks">
                                   <hr class="print-line">
                                   <p><strong class="header text-left">Remarks : </strong> </p>

                                   <div [innerHTML]="(loanDataHolder?.loanHolder?.financial?.historicalProjected | jsonParse)?.remarks || 'N/A' | safeHtml"></div>
                               </div>
                           </ng-container>
                           <div class="col-md-12" *ngIf="netTradingAssetsSummary">
                               <hr class="print-line">
                           <app-net-trading-assets-view *ngIf="netTradingAssetsSummary"
                                                        [loanDataHolder] = "loanDataHolder"
                                                        [netTradingAssets] = "loanDataHolder.loanHolder.netTradingAssets"></app-net-trading-assets-view>
                           </div>

                           <ng-container *ngIf="smallBusiness">
<!--                               <div class="col-md-12 form-group">-->
<!--                                   <div class="row">-->
<!--                                       <div class="col-md-12 text-left">-->
<!--                                           <b class="header">Fixed Assets Summary (proposed hypothecation)</b>-->
<!--                                       </div>-->
<!--                                   </div>-->
<!--                                   <p class="text-right">(Amount in NPR ‘000s)</p>-->
<!--                                   <table class="table table-sm table-bordered table-hover sb-small text-center">-->
<!--                                       <thead>-->
<!--                                       <tr class="sb-bg-gray">-->
<!--                                           <th>S.N</th>-->
<!--                                           <th>Particulars</th>-->
<!--                                           <th>Unit</th>-->
<!--                                           <th>Rate</th>-->
<!--                                           <th>Total</th>-->
<!--                                           <th>Remarks</th>-->
<!--                                       </tr>-->
<!--                                       </thead>-->
<!--                                       <tbody class="text-left">-->
<!--                                       <tr *ngFor="let fixedAssets of proposalAllData?.fixedAssetsSummary; let i = index"-->
<!--                                           style="text-align: center;">-->
<!--                                           <ng-container>-->
<!--                                               <td>{{i + 1}}</td>-->
<!--                                               <td>{{fixedAssets?.particular || 'NA'}}</td>-->
<!--                                               <td>{{fixedAssets?.unit || 'NA'}}</td>-->
<!--                                               <td>{{fixedAssets?.rate || 'NA'}}</td>-->
<!--                                               <td>{{fixedAssets?.total || 'NA'}}</td>-->
<!--                                               <td>{{fixedAssets?.remarks || 'NA'}}</td>-->
<!--                                           </ng-container>-->
<!--                                       </tr>-->
<!--                                       </tbody>-->
<!--                                   </table>-->
<!--                               </div>-->
                               <div class="col-md-12 form-group">
                                   <hr class="print-line">
                                   <div class="row">
                                       <div class="col-md-12 text-left">
                                           <b class="header">Summary of Environment & Social Risk Assessment</b>
                                       </div>
                                   </div>
                                   <table class="table table-sm table-bordered table-hover sb-small text-center summary">
                                       <thead>
                                       <tr class="sb-bg-gray">
                                           <th>S.N</th>
                                           <th>Particulars</th>
                                           <th>Remarks</th>
                                       </tr>
                                       </thead>
                                       <tbody class="text-left">
                                       <tr>
                                           <td>1</td>
                                           <td class="text-left">Falls under Exclusion and critical sector list</td>
                                           <td class="text-center">
                                               {{proposalAllData?.summaryEnvironment?.criticalSector ? 'YES' : 'NO'}}
                                           </td>
                                       </tr>
                                       <tr>
                                           <td>2</td>
                                           <td class="text-left">E & S Due Diligence process Applicable</td>
                                           <td class="text-center">
                                               {{proposalAllData?.summaryEnvironment?.processApplicable ? 'YES' : 'NO'}}

                                           </td>
                                       </tr>
                                       <tr>
                                           <td>3</td>
                                           <td class="text-left">Level of Risk</td>
                                           <td class="text-center">
                                               {{proposalAllData?.summaryEnvironment?.priority || 'NA'}}


                                           </td>
                                       </tr>
                                       <tr>
                                           <td>4</td>
                                           <td class="text-left">Falls under Exclusion and critical sector list</td>
                                           <td class="text-center">
                                               {{proposalAllData?.summaryEnvironment?.criticalSectorList || 'NA'}}

                                           </td>
                                       </tr>
                                       </tbody>
                                   </table>
                               </div>
                           </ng-container>
                           <div class="col-md-12" *ngIf="!isCorporate">
                           <ng-container *ngIf="checkedData?.waiverChecked">
                               <hr class="print-line">
                               <p><strong class="header">Waivers</strong></p>
                               <div class="col-md-12 table-condensed table-responsive-md" [innerHTML]="proposalAllData?.waiverConclusionRecommendation || 'N/A' | safeHtml">
                               </div>
                           </ng-container>
                           <ng-container *ngIf="checkedData?.deviationChecked">
                               <hr class="print-line">
                               <p><strong class="header">Deviation</strong></p>
                               <div class="col-md-12 table-condensed table-responsive-md" [innerHTML]="proposalAllData?.deviationConclusionRecommendation || 'N/A' | safeHtml">
                               </div>
                           </ng-container>
                           </div>
                       </div>
                   </div>
               </ng-container>

               <div *ngIf="loanDataHolder?.dmsLoanFile !== null" class="row">
                   <div class="col-md-12">
                       <hr class="print-line">
                       <p><strong class="header">Detail of Present Proposal of the Facility</strong></p>
                       <table class="table table-bordered text-center table-sm sb-small summary">
                           <tbody>
                           <tr>
                               <th>Credit Facility</th>
                               <td>{{loanDataHolder?.loan?.name}}</td>

                               <th>Proposed Limit</th>
                               <td>{{dmsLoanFile?.proposedAmount
                               || loanDataHolder?.proposal?.proposedLimit | currencyFormatter}}</td>

                               <th>Interest Rate</th>
                               <td>{{dmsLoanFile?.interestRate || loanDataHolder?.proposal?.interestRate}} %</td>

                               <th>Tenure Duration In Month</th>
                               <td>{{(dmsLoanFile?.tenureDuration
                                   || loanDataHolder?.proposal?.tenureDurationInMonths)}}</td>

                           </tr>
                           <tr>
                               <th>Loan Administration Fee</th>
                               <td>{{dmsLoanFile?.serviceChargeType === 'Flat' ? ' NRs. ' : ''}}
                                   {{dmsLoanFile?.serviceChargeAmount || loanDataHolder?.proposal?.serviceCharge}}
                                   {{dmsLoanFile?.serviceChargeType === 'Percentage' ? ' %' : ''}}
                               </td>

                               <th>FMV Funding Percentage</th>
                               <td>{{dmsLoanFile?.fmvFundingPercent}} %</td>

                               <th>Total FMV</th>
                               <td>{{dmsLoanFile?.fmvTotal | currencyFormatter}}</td>

                               <th>Total DV</th>
                               <td>{{dmsLoanFile?.distressValue | currencyFormatter}}</td>

                               <th>Total Loan Limit</th>
                               <td>{{dmsLoanFile?.totalLoanLimit | currencyFormatter}}</td>
                           </tr>
                           <tr>
                               <th>Institution Exposure</th>
                               <td>{{dmsLoanFile?.institutionExposure | currencyFormatter}}</td>

                               <th>Group Exposure</th>
                               <td>{{dmsLoanFile?.groupExpo | currencyFormatter}}</td>

                               <th>Debt Service Coverage
                                   Ratio
                               </th>
                               <td>{{dmsLoanFile?.debtServiceCoverageRatio}}</td>

                               <th>Dealing Product Name</th>
                               <td>{{dmsLoanFile?.dealingProductName}}</td>
                           </tr>
                           <tr>
                           </tr>
                           </tbody>
                       </table>
                   </div>
               </div>
           </ng-container>
            <div *ngIf="loanDataHolder?.loanHolder?.facilityUtilization">
                <hr class="print-line">
                <app-facility-utilization
                        [fromProfile]="false"
                        [facilityUtilizationData]="loanDataHolder?.loanHolder?.facilityUtilization">
                </app-facility-utilization>
            </div>
            <hr class="print-line">
            <app-all-document-view *ngIf="loanDataHolder" [loanDataHolder]="loanDataHolder"
                                   [siteVisitDocument]="siteVisitDocuments"></app-all-document-view>
            <hr class="print-line">
            <div class="row mt-3">
                <div class="col-md-12">
                    <p><strong class="header">Authority Section</strong></p>
                    <table
                            class="table table-condensed table-bordered table-responsive-md text-center table-sm sb-small summary">
                        <thead>
                        <tr class="sb-bg-gray">
                            <th>S.N</th>
                            <th>Date</th>
                            <th>From User</th>

                            <th>To User</th>

                            <th>Status</th>
                            <th class="cmt-width">Remarks</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let previousList of loanDataHolder?.previousList ; let i = index">
                            <td>{{i + 1}}</td>
                            <td class="text-left pl-1">
                                {{previousList?.lastModifiedAt | date}}
                            </td>
                            <td class="text-left">
                                <div class="pl-1">
                                    {{previousList?.fromUser?.name}}</div>
                                <div class="pl-1">
                                    <span>({{previousList?.fromRole?.roleName}})</span>
                                </div>
                            </td>

                            <td class="text-left">
                                <div class="pl-1">
                                    {{previousList?.toUser?.name}}</div>
                                <div class="pl-1">
                                    ({{previousList?.toRole?.roleName}})
                                </div>
                            </td>

                            <td class="text-left pl-1">{{previousList?.docAction | loanStatusPipe }}</td>
                            <td class="text-left">
                                <div class="pl-1" [innerHTML]="customSafePipe(
                                    previousList?.comment?.length > 50 ?
                                    previousList?.comment?.substring(0, 49) :
                                    previousList?.comment)">
                                </div>
                                <a (click)="open(previousList?.comment)"
                                   *ngIf="previousList?.comment?.length > 50"
                                   class="text-left pl-1 disable-print">read more ....</a>
                                <div>
                                    <span class="pl-1 print-only justify-content"
                                          [innerHTML]="previousList?.comment | safeHtml"></span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>{{currentIndex + 1}}</td>
                            <td class="text-left pl-1">{{loanDataHolder?.currentStage?.lastModifiedAt | date}}
                            </td>
                            <td class="text-left">
                                <div class="pl-1">
                                    {{loanDataHolder?.currentStage?.fromUser?.name}}</div>
                                <div class="pl-1">
                                    <span>({{loanDataHolder?.currentStage?.fromRole?.roleName}})</span>
                                </div>
                            </td>

                            <td class="text-left">
                                <div class="pl-1">
                                    {{loanDataHolder?.currentStage?.toUser?.name}}</div>
                                <div class="pl-1">
                                    <span>({{loanDataHolder?.currentStage?.toRole?.roleName}})</span>
                                </div>
                            </td>

                            <td class="text-left pl-1">{{loanDataHolder?.currentStage?.docAction | loanStatusPipe }}</td>
                            <td class="text-left">
                                <div class="pl-1">
                                    <span [innerHTML]="customSafePipe(loanDataHolder?.currentStage?.comment?.length > 50 ?
                                    loanDataHolder?.currentStage?.comment?.substring(0, 49) :
                                    loanDataHolder?.currentStage?.comment)"></span>
                                </div>
                                <a (click)="open(loanDataHolder.currentStage.comment)"
                                   *ngIf="loanDataHolder?.currentStage?.comment?.length > 50"
                                   class="text-left pl-1 disable-print">read more ....</a>
                                <div>
                                    <span class="pl-1 print-only text-justify pr-1"
                                          [innerHTML]="loanDataHolder?.currentStage?.comment | safeHtml"></span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div *ngIf="signatureList.length > 0" class="row summary justify-content-between px-3"
                 id="signatureDiv">
                <div class="col-md-12 print-only">
                    <p><strong class="header">Approval Chain</strong></p>
                </div>
                <div class="row col-md-12 summary" style="height: 210px; max-height: 210px">
                    <div *ngFor="let previous of signatureList; let i=index;"
                         class="col-md-3 padding-0-125">
                        <div class="signature-block" style="height: 100%;">
                            <div class="text-center p-2 bg-light mb-2 sb-small sb-bg-gray">
                                <span>{{loanHandler(i, signatureList.length, (previous.docAction.toString() === 'RE_INITIATE') ? previous?.toUser?.role?.authorityLabel : previous?.fromUser?.role?.authorityLabel)}}</span>
                            </div>
                            <hr class="border-dark m-0">
                            <div class="row justify-content-center signature mx-auto" style="height: 80px; max-height: 80px">
                                <div class="print-only signature-padding"></div>
                                <img align="middle" alt="signature" style="height: 100%; width: 100%"
                                     class="img-thumbnail border-0 signature-height signature-width"
                                     src="{{(previous.docAction.toString() === 'RE_INITIATE') ? (previous.toUser?.signatureImage === null ? '' : RootUrl + '/' + previous.toUser?.signatureImage) : (previous.fromUser?.signatureImage === null ? '' : RootUrl + '/' + previous.fromUser?.signatureImage)}}"/>
                            </div>
                            <div class="text-center signature-detail sb-bg-gray">
                                <span class="m-0 sb-small">{{(previous.docAction.toString() === 'RE_INITIATE') ? previous?.toUser?.name : previous?.fromUser?.name}}</span>
                                <span class="m-0 sb-small">
                                    ({{(previous.docAction.toString() === 'RE_INITIATE') ? previous?.toUser?.role?.roleName : previous?.fromUser?.role?.roleName}})
                                </span>
                                <p class="m-0 sb-small">{{previous?.lastModifiedAt | date}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br>
        </div>
    </div>
</section>

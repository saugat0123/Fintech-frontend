<nb-card>
    <nb-card-header>
        <h3>{{memoTask}} Diary Note</h3>
    </nb-card-header>
    <form (ngSubmit)="saveMemo()" [formGroup]="memoComposeForm">
        <nb-card-body>
            <div class="col-md-12">

                <div class="form-group">
                    <input [ngClass]="{
                               'is-invalid': subject.invalid && (subject.dirty || subject.touched),
                                'is-valid': !subject.invalid && (subject.dirty || subject.touched)
                                }" class="form-control" formControlName="subject" placeholder="Subject:">
                </div>

                <div class="form-group">
                    <input [ngClass]="{
                               'is-invalid': refNumber.invalid && (refNumber.dirty || refNumber.touched),
                                'is-valid': !refNumber.invalid && (refNumber.dirty || refNumber.touched)
                                }" class="form-control" formControlName="referenceNumber" placeholder="Reference No:">
                </div>
                <div class="form-group">
                    <ng-select
                            (change)="getCreditMemoTypeDocuments($event)"
                            [closeOnSelect]="true"
                            [hideSelected]="true"
                            [items]="memoTypes"
                            [multiple]="false"
                            [ngClass]="{
                               'is-invalid': type.invalid && (type.dirty || type.touched),
                                'is-valid': !type.invalid && (type.dirty || type.touched)
                                }"
                            bindLabel="name"
                            formControlName="type" placeholder="Select Diary Note type">
                    </ng-select>
                </div>
                <div class="form-group">
                    <ng-select
                            [closeOnSelect]="true"
                            [hideSelected]="true"
                            [items]="customerLoanList"
                            [multiple]="true"
                            [(ngModel)]="allApproveLoan"
                            [ngClass]="{
                               'is-invalid': customerLoan.invalid && (customerLoan.dirty || customerLoan.touched),
                                'is-valid': !customerLoan.invalid && (customerLoan.dirty || customerLoan.touched)
                                }"
                            bindLabel="loan.name"
                            formControlName="customerLoan" >
                        <ng-template let-index="index" let-item="item" let-search="searchTerm" ng-option-tmp>
                            Holder name: <strong>{{item['customerInfo']['customerName']}}</strong> |
                            Loan category: <strong> {{item['loanCategory']}}</strong>
                        </ng-template>

                    </ng-select>
                </div>
                <div class="form-group" >
                    <form [formGroup] = "proposalForm" >
                        <div class="row" formArrayName="data" *ngFor="let proposal of proposalForm.get('data')['controls']; let i = index">
                        <ng-container class="form-group" formGroupName="{{i}}">
                            <h6>{{allApproveLoan[i]?.loan?.name}}</h6><br>
                            <ng-container  class="form-group"  [formGroup] ="proposal.get('proposalData')">
                               <div class="col-md-4" >
                                   <div class="form-group">
                                       <label class="title" for="outStandingLimit">
                                           <strong>Outstanding Limit</strong>
                                       </label>
                                       <input class="form-control"
                                              formControlName="outStandingLimit" id="outStandingLimit"
                                              name="outStandingLimit" placeholder="Limit Amount"
                                              type="number">
                                   </div>
                               </div>
                               <div class="col-md-4">
                                   <div class="form-group">
                                       <label class="title" for="proposedLimit"><strong>Approved Limit</strong></label>
                                       <input
                                               class="form-control"
                                               formControlName="proposedLimit" id="proposedLimit"
                                               name="proposedLimit" placeholder="Approved limit"
                                               type="number" appDecimalNumber>

                                   </div>
                               </div>
                           </ng-container>
                       </ng-container>
                        </div>
                    </form>
                </div>
<!--            <app-security-summary *ngIf="allApproveLoan?.length > 0" [customerAllLoanList]="allApproveLoan" [securities]="mergeSecurity" [pending] = "false" ></app-security-summary>-->
                <!--Document upload-->
                <div class="form-group">
                    <ckeditor [config]="ckeConfig" formControlName="content"></ckeditor>
                </div>
                <nb-card [nbSpinner]="docSpinner" class="mt-2">
                    <div *ngIf="creditMemoDocuments.length > 0 || creditMemoTypeDocuments.length>0" class="col-md-12">
                        <div class="box-header with-border">
                            <h3 class="box-title my-3">Documents required for credit diary note</h3>
                            <ul>
                                <li>Select File smaller than <strong>10MB</strong>
                                </li>
                            </ul>

                        </div>
                    </div>
                    <div class="col-md-12">

                        <div *ngIf="errorMessage">
                            <span class="color" style="color:red"> {{errorMessage}}</span>
                        </div>
                        <div class="box-body" *ngIf="creditMemoTypeDocuments.length > 0">
                            <h6>Credit Diary Note Type Document</h6>
                            <table aria-describedby="required-documents-credit-memo"
                                   class="table table-striped table-bordered table-hover ">
                                <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Document Type</th>
                                    <th scope="col">Upload</th>
                                    <th scope="col">Upload Status</th>
                                    <th scope="col">View</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr *ngFor="let document of creditMemoTypeDocuments; let i=index">
                                    <td>
                                        {{i + 1}}
                                    </td>
                                    <td>{{document.name}}</td>
                                    <td><input
                                            (change)="documentUploader($event, document, i, editedCreditMemoTypeDocuments)"
                                            class="form-control-file"
                                            id="uploadCreditMemoTypeDocument{{i}}"
                                            type="file">
                                    </td>
                                    <td>
                                   <span *ngIf="document.checked" style="color:limegreen">
                                       <em class="fas fa-check-circle"></em>
                                   </span>
                                        <span *ngIf="!document.checked || document.checked === null" style="color:red">
                                       <em class="fas fa-times-circle"></em>
                                   </span>
                                    </td>
                                    <td>
                                        <i style="cursor: pointer" *ngIf="document.checked" class="fas fa-eye"
                                           (click)="previewGeneralDoc(document.url,document.name,i,'creditTypeMemoDocument')"></i>
                                        <i style="cursor: pointer"
                                           *ngIf="!document.checked || document.checked === null"
                                           class="fas fa-times-circle"></i>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="box-body" *ngIf="creditMemoDocuments.length > 0">
                            <h6>Facility Memo Document</h6>
                            <table aria-describedby="required-documents-credit-memo"
                                   class="table table-striped table-bordered table-hover ">
                                <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Document Type</th>
                                    <th scope="col">Upload</th>
                                    <th scope="col">Upload Status</th>
                                    <th scope="col">View</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr *ngFor="let document of creditMemoDocuments; let i=index">
                                    <td>
                                        {{i + 1}}
                                    </td>
                                    <td>{{document.name}}</td>
                                    <td><input
                                            (change)="documentUploader($event, document, i, editedCreditMemoDocuments)"
                                            accept=".pdf"
                                            class="form-control-file"
                                            id="uploadDocument{{i}}"
                                            type="file">
                                    </td>
                                    <td>
                                   <span *ngIf="document.checked" style="color:limegreen">
                                       <em class="fas fa-check-circle"></em>
                                   </span>
                                        <span *ngIf="!document.checked || document.checked === null" style="color:red">
                                       <em class="fas fa-times-circle"></em>
                                   </span>
                                    </td>
                                    <td>
                                        <i style="cursor: pointer" *ngIf="document.checked" class="fas fa-eye"
                                           (click)="previewGeneralDoc(document.url, document.name,i,'FacilityCreditMemoDocument')"></i>
                                        <i style="cursor: pointer"
                                           *ngIf="!document.checked || document.checked === null"
                                           class="fas fa-times-circle"></i>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>


                </nb-card>


            </div>

        </nb-card-body>
        <nb-card-footer>
            <div class="col-md-12">

                <div class="float-right">
                    <button [disabled]="!memoComposeForm.valid" nbButton size="small" status="success" type="submit">
                        <em class="fa fa-envelope-o"></em> Save
                    </button>
                </div>
            </div>
            <div class="clearfix"></div>
        </nb-card-footer>
    </form>
</nb-card>
<app-overlay-spinner></app-overlay-spinner>

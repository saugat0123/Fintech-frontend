<nb-card style="max-height: 90vh;">
    <nb-card-header>
        <div>
            <div class="float-left">
                <button (click)="onBack()" class="btn-primary float-left"><i class="fas fa-arrow-left"></i>
                </button>
            </div>
            <div class="float-right">
                <button [useExistingCss]="true" class="btn-sm btn-warning float-right" ngxPrint
                        printSectionId="print-detail" styleSheetFile="assets/css/printStyles.scss">
                    PRINT
                    <!--                <i class="col-md-1 fa fa-print"></i>-->
                </button>
            </div>
            <div class="float-right">
                <button [nbPopover]="allDocumentView" class="btn-sm btn-success float-right">
                    UPLOADED DOCUMENT
                    <!--                <i class="col-md-1 fa fa-file"></i>-->
                </button>
            </div>
        </div>
    </nb-card-header>
    <nb-card-body>
        <div id="print-detail">
            <div class="row">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mt-2">
                                Loan Status:
                                <span class="badge badge-info"
                                      style="font-size: 13px">{{loanDataHolder?.documentStatus?.toString() |
                                    titlecase}}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="report-header text-center">
                                <div class="report-header-heading mb-2">
                                    {{client}}
                                </div>
                                <ng-container>
                                    <div>
                                        <span class="report-header-sub-heading"> Credit Appraisal </span>
                                        <br/>
                                        <span class="report-header-sub-heading"> for </span>
                                    </div>
                                    <div *ngIf="!isJointInfo">
                                        <span class="report-header-sub-heading">
                                            <strong>
                                                {{loanCategory === 'INSTITUTION' ?
                                                loanDataHolder?.companyInfo?.companyName
                                                : loanDataHolder?.customerInfo?.customerName}}
                                            </strong>
                                        </span>
                                    </div>
                                    <div class="report-header-sub-heading" *ngIf="isJointInfo">
                                        <div *ngFor="let jointCustomer of jointInfo">
                                            <ng-container *ngFor="let info of jointCustomer">
                                                <span class="sb-medium">{{loanCategory === 'INSTITUTION' ?
                                                    loanDataHolder?.companyInfo?.companyName :
                                                    info?.customerName}}</span><br/>
                                            </ng-container>
                                        </div>
                                    </div>
                                </ng-container>
                                <div class="report-header-sub-heading mt-1 ml-1 mb-1">{{loanDataHolder?.branch?.name}}
                                    Branch
                                    ,
                                    {{loanDataHolder?.branch?.province?.name}}</div>
                            </div>
                        </div>
                        <div class="col-md-3 text-right">
                            <img class="report-log img-thumbnail border-0" src="../../../../../assets/img/logo.png">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-9 d-flex justify-content-start">
                <div>
                    <button nbButton outline (click)="onOpen()" class="btn btn-danger btn-flat btn-sm" type="button">
                        Credit Scoring Report
                    </button>
                </div>
            </div>
            <hr>
            <!--            <section class="container-fluid">-->
            <!--                <div class="row">-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">TO</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: <span-->
            <!--                                        class="font-weight-bold">{{loanDataHolder?.currentStage?.toUser?.name}}</span>-->
            <!--                                </p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">THROUGH</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: ...................</p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">FROM</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: <span-->
            <!--                                        class="font-weight-bold">{{loanDataHolder?.currentStage?.fromUser?.name}}</span>-->
            <!--                                </p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">SUBJECT</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: <span-->
            <!--                                        class="font-weight-bold">{{loanDataHolder?.currentStage?.docAction}}</span></p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">CLIENT NAME</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: <span-->
            <!--                                        class="font-weight-bold">{{loanDataHolder?.loanHolder?.name}}</span></p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">GROUP(Name,Code)</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">{{loanDataHolder?.loanHolder?.mgroupInfo?.groupName}}, {{loanDataHolder?.loanHolder?.mgroupInfo?.groupCode}}</p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small" *ngFor="let item of individualData?.accountDetails; let i = index">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">ACCOUNT NUMBER {{i + 1}}</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: <span class="font-weight-bold">{{item?.accountNo}}</span></p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-12 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="font-weight-bold sb-small">CUSTOMER ID</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-2">-->
            <!--                                <p class="sb-small">: <span-->
            <!--                                        class="font-weight-bold">{{loanDataHolder?.loanHolder?.idNumber}}</span></p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-6 sb-small">-->
            <!--                        <div class="row">-->
            <!--                            <div class="col-md-4">-->
            <!--                                <p class="font-weight-bold sb-small">DATE</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-4">-->
            <!--                                <p class="sb-small">: <span-->
            <!--                                        class="font-weight-bold">{{loanDataHolder?.loanHolder?.idRegDate | date}}</span>-->
            <!--                                </p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    <div class="col-md-6 sb-small">-->
            <!--                        <div class="row justify-content-end">-->
            <!--                            <div class="col-md-4">-->
            <!--                                <p class="font-weight-bold sb-small text-right">REF. NO. CCBL</p>-->
            <!--                            </div>-->
            <!--                            <div class="col-md-4">-->
            <!--                                <p class="sb-small">: <span class="font-weight-bold">{{loanDataHolder.refNo}}</span></p>-->
            <!--                            </div>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </section>-->

            <!-- DO NOT REMOVE -->

            <div class="row ">
                <div class="col-md-12 sb-small">
                    <div class="clearfix">
                        <div class="float-right"><span><strong>Ref. No: </strong>{{loanDataHolder?.refNo}}</span></div>
                        <div class="float-right" *ngIf="loanDataHolder?.isSol">
                            <span><strong>Final Approver: </strong>{{loanDataHolder?.solUser?.name}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row sb-small">
                <div class="col-md-12">
                    <b>Purpose: {{loanDataHolder?.loan?.name}}</b>
                    <span class="float-right"><b>Loan Authority Under</b>- {{loanDataHolder?.currentStage?.toUser?.name}}
                        ({{loanDataHolder?.currentStage?.toRole?.roleName}})</span>
                </div>
            </div>
            <div class="row sb-small mb-1">
                <div class="col-md-12">
                    <span> <b>Application Received On:</b> {{loanDataHolder?.createdAt | date}}
                        ({{loanDataHolder?.createdAt | engNepDate: false}})</span>
                    <span class="float-right"><b>
                        <span *ngIf="currentDocAction === 'FORWARD'">Forwarded</span>
                        <span *ngIf="currentDocAction === 'BACKWARD'">Backwarded</span> by: </b>{{loanDataHolder?.currentStage?.fromUser?.name}}
                        ({{loanDataHolder?.currentStage?.fromRole?.roleName}})
                        <b> on:</b> {{loanDataHolder?.lastModifiedAt | date}}
                        ({{loanDataHolder?.lastModifiedAt | engNepDate: false}})
                    </span>

                </div>
            </div>
            <hr>
            <div *ngIf="crgGammaSummary" class="col-md-12">
                <nb-card class="sb-medium">
                    <nb-card-header class="text-center">
                        <h6>Credit Risk Gauge</h6>
                    </nb-card-header>
                    <nb-card-body>
                        <div class="row">
                            <div class="col-md-6 text-right">
                                <app-gauge-chart [chartHeight]="180" [chartWidth]="275" [maxValue]="100"
                                                 [obtainedValue]="crgGammaScore"
                                                 gaugeIdentifier="crg-gamma"></app-gauge-chart>
                            </div>
                            <div class="col-md-6 gauge-label-padding">
                                <div class="vertical-line">
                                    <div class="text-left pl-2">
                                        Credit Risk Grade:
                                        <span [class]="crgGammaGradeStatusBadge">
                                                {{crgGammaGrade | titlecase}}</span>
                                    </div>
                                    <br>
                                    <div class="text-left pl-2">
                                        Credit Risk Score:
                                        <span><strong> {{ crgGammaScore }}</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nb-card-body>
                </nb-card>
            </div>
            <div class="container-fluid">
                <ol class="heading-list">
                    <li>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Date of Association: </strong>{{loanDataHolder?.createdAt | date}}
                                    ({{loanDataHolder?.createdAt | engNepDate:false}})</p>
                            </div>
                            <div class="col-md-6 text-right">
                                <p><strong>Late Date of
                                    Inspection: </strong>{{lastDateOfInspection ? (lastDateOfInspection | date) : 'NA'}}
                                    ({{lastDateOfInspection ? (lastDateOfInspection | engNepDate: false) : 'NA'}})</p>
                                <p><strong>Obligation Group (Name/Code): </strong>
                                    {{loanDataHolder?.loanHolder?.mgroupInfo?.groupName ? loanDataHolder?.loanHolder?.mgroupInfo?.groupName : 'NA'}}
                                    /
                                    {{loanDataHolder?.loanHolder?.mgroupInfo?.groupCode ? loanDataHolder?.loanHolder?.mgroupInfo?.groupCode : 'NA'}}
                                </p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p><strong>REQUEST OF THE CLIENT : </strong></p>
                        <p class="sb-small">The client has requested us
                            for {{customerAllLoanList?.length > 1 ? 'following loan' :
                                loanDataHolder?.loan?.name + ' of NPR ' + loanDataHolder?.proposal?.proposedLimit + '@' +
                                (loanDataHolder?.proposal?.data | jsonParse)?.interestRate + '% p.a for ' +
                                ((loanDataHolder?.proposal?.data | jsonParse)?.tenureDurationInMonths ? (loanDataHolder?.proposal?.data | jsonParse)?.tenureDurationInMonths / 12 + ' year(s)' : 'NA')  }}</p>
                        <div *ngIf="customerAllLoanList?.length > 1">
                            <ol type="a">
                                <li class="sb-small p-0 m-0" *ngFor="let cal of customerAllLoanList">
                                    {{cal?.loanType | replace: '_' : ' '}} of {{cal?.loan?.name}}<b> of
                                    NPR {{cal?.proposal?.proposedLimit | currencyFormatter}}
                                    @{{(cal.proposal.data | jsonParse)?.interestRate}}% p.a
                                    for {{(cal.proposal.data | jsonParse)?.tenureDurationInMonths ?
                                        (cal.proposal.data | jsonParse)?.tenureDurationInMonths / 12 + ' year(s)' : 'NA'}}
                                </b></li>
                            </ol>
                        </div>
                    </li>
                    <li>
                        <p><strong>PERSONAL/BUSINESS BACKGROUND : </strong></p>
                        <app-customer-business-activity-or-backgrounds
                                *ngIf="loanDataHolder.loanHolder || loanDataHolder.customerInfo"
                                [customer]="loanDataHolder.customerInfo"
                                [loanHolder]="loanDataHolder.loanHolder">
                        </app-customer-business-activity-or-backgrounds>
                    </li>

                    <li>
                        <p><strong>FINANCIAL PERFORMANCE : {{loanHolder?.financial ? '' : 'NA'}}</strong></p>
                        <app-financial-view *ngIf="loanHolder?.financial"
                                            [customerType]="loanHolder?.customerType"
                                            [formData]="loanHolder?.financial"></app-financial-view>
                    </li>

                    <li>
                        <p><strong>PURPOSE AND JUSTIFICATION OF CREDIT
                            PROPOSAL: {{loanDataHolder?.proposal ? '' : 'NA'}}</strong></p>
                        <app-retail-purpose-and-justification *ngIf="loanDataHolder?.proposal"
                                                              [loanDataHolder]="loanDataHolder"
                                                              [proposalData]="loanDataHolder?.proposal"></app-retail-purpose-and-justification>
                    </li>
                    <li>
                        <p><strong>SOURCE OF REPAYMENT : {{loanHolder?.financial ? '' : 'NA'}}</strong></p>
                        <app-retail-source-of-repayment
                                *ngIf="loanHolder?.financial"
                                [formData]="loanHolder?.financial"></app-retail-source-of-repayment>
                    </li>
                    <li>
                        <p><strong>CURRENT LIMITS AND OUTSTANDING OF THE CLIENT : <em class="text-danger sb-small">Bold
                            row indicates current loan proposal</em> </strong></p>
                        <app-proposal-view *ngIf="loanDataHolder?.proposal"
                                           [customerAllLoanList]="customerAllLoanList"
                                           [proposalData]="loanDataHolder?.proposal"
                                           [loanDataHolder]="loanDataHolder"></app-proposal-view>
                    </li>
                    <li>
                        <p class="text-uppercase"><strong>Name of the companies under the
                            group: {{companyGroup?.length > 0 ? '' : 'NA'}}</strong></p>
                        <div class="col-md-4" *ngIf="companyGroup?.length > 0">
                            <table class="table table-responsive-md table-bordered text-center table-sm">
                                <tbody>
                                <tr *ngFor="let cg of companyGroup; let cgi = index">
                                    <td class="sn sb-bg-secondary" colspan="1">{{cgi + 1}}</td>
                                    <td colspan="3">{{cg?.name}}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </li>

                    <li>
                        <!-- group position -->
                        <strong>GROUP EXPOSURE (in NPR.) {{loanDataHolder?.loanHolder?.mgroupInfo ? ('as of ' +
                            (loanDataHolder?.loanHolder.mgroupInfo?.groupExposureDate ? (loanDataHolder?.loanHolder.mgroupInfo?.groupExposureDate | date) : 'NA')) : ': NA'}}</strong>
                        <app-m-group-summary *ngIf="loanDataHolder?.loanHolder?.mgroupInfo"
                                             [mGroup]="loanDataHolder?.loanHolder?.mgroupInfo"
                                             [customerType]="loanDataHolder?.loanHolder?.customerType"></app-m-group-summary>
                    </li>
                    <li>
                        <p class="text-uppercase"><strong>Regularity of
                            payments: {{commonLoanData?.regularityOfPayments ? commonLoanData?.regularityOfPayments : 'NA'}}</strong>
                        </p>
                    </li>
                    <li>
                        <p class="text-uppercase">
                            <strong>Profitability {{loanHolder?.incomeFromAccount ? '' : 'NA'}}</strong></p>
                        <app-income-from-account-summery *ngIf="loanHolder?.incomeFromAccount"
                                                         [formData]="loanHolder?.incomeFromAccount">
                        </app-income-from-account-summery>
                    </li>
                    <li>
                        <p class="text-uppercase"><strong>Risks
                            : {{loanDataHolder?.loanHolder?.riskAnalysis ? '' : 'NA'}}</strong></p>
                        <app-above-risk-analysis *ngIf="loanDataHolder?.loanHolder?.riskAnalysis"
                                                 [customerInfo]="loanDataHolder?.loanHolder"></app-above-risk-analysis>
                    </li>
                    <li>
                        <p><strong
                                class="text-uppercase">Compliance: </strong> {{proposalData?.compliance ? 'We have fully adhered the policy of NRB and internal bank policies.' : 'NA'}}
                        </p>
                        <tr>
                            <td [innerHTML]="proposalData?.compliance || 'NA' | safeHtml"></td>
                        </tr>
                    </li>
                    <li *ngIf="loanDataHolder?.loan?.loanTag === 'SHARE_SECURITY'">
                        <p><strong>Debt Structure and Control Mechanism: For Overdraft/Demand Loan (Loan Against
                            Share)</strong>
                            <span [innerHTML]="proposalData?.debtStructure || 'NA' | safeHtml"></span>
                    </li>
                    <li>
                        <p class="text-uppercase"><strong>Banking Arrangement
                            : {{loanDataHolder?.loanHolder?.multiBanking ? '' : 'NA'}}</strong></p>
                        <app-above-banking-arrangement-of-the-customer
                                *ngIf="loanDataHolder?.loanHolder?.multiBanking || loanDataHolder?.loanHolder?.cicl"
                                [multiBanking]="loanDataHolder?.loanHolder?.multiBanking"
                                [proposal]="loanDataHolder?.proposal"
                                [cicl]="loanDataHolder?.loanHolder?.cicl"
                                [customerCategory]="loanDataHolder?.loanHolder?.customerCategory"
                                [customerType]="loanDataHolder?.loanHolder?.customerType"></app-above-banking-arrangement-of-the-customer>
                    </li>
                    <li>
                        <p class="text-uppercase"><b>MIS/NRB
                            REPORTING: {{loanDataHolder?.loanHolder?.reportingInfoLevels?.length > 0 ? '' : ' NA'}}</b>
                        </p>
                        <app-report-summary *ngIf="loanDataHolder?.loanHolder?.reportingInfoLevels?.length > 0"
                                            [reportingInfoLevels]="loanDataHolder?.loanHolder?.reportingInfoLevels"></app-report-summary>
                    </li>
                    <li>
                        <p><strong>WAIVERS, DEVIATIONS, DIFERRALS AND REBETS <em>(IF ANY)</em>:
                            {{proposalData?.waiverConclusionRecommendation ? '' : ' NA'}}</strong></p>
                        <tr *ngIf="proposalData?.waiverConclusionRecommendation">
                            <td [innerHTML]="proposalData?.waiverConclusionRecommendation | safeHtml"></td>
                        </tr>
                    </li>
                    <li>
                        <p><strong>SECURITY DETAILS: {{loanDataHolder?.loanHolder?.security ? '' : ' NA'}}</strong></p>
                        <app-retail-security *ngIf="loanDataHolder?.loanHolder?.security"
                                             [loanDataHolder]="loanDataHolder"
                                             [security]="loanDataHolder?.loanHolder?.security"></app-retail-security>
                    </li>
                    <li>
                        <p>
                            <b>INSPECTIONS: {{loanDataHolder?.loanHolder?.siteVisit || fixedAssetsData?.length > 0 ? '' : 'NA'}}</b>
                        </p>
                        <app-site-visit-view
                                *ngIf="loanDataHolder?.loanHolder?.siteVisit || fixedAssetsData?.length > 0"
                                [siteVisit]="loanDataHolder?.loanHolder?.siteVisit"
                                [fixedAssetsData]="fixedAssetsData"></app-site-visit-view>
                    </li>

                    <li>
                        <p><strong>DETAIL OF INSURANCE: {{loanDataHolder?.insurance?.length > 0 ? '' : 'NA'}}</strong>
                        </p>
                        <app-insurance-summary *ngIf="loanDataHolder?.insurance?.length > 0"
                                               [insurance]="loanDataHolder?.insurance"></app-insurance-summary>
                    </li>
                    <li>
                        <p><strong>REVIEW OF CREDIT
                            FACILITIES: {{(loanDataHolder?.loanHolder?.data | jsonParse)?.reviewDate ? '' : 'NA'}}</strong>
                        </p>
                        <app-above-review-of-credit-facilities
                                *ngIf="(loanDataHolder?.loanHolder?.data | jsonParse)?.reviewDate"
                                [loanDataHolder]="loanDataHolder"></app-above-review-of-credit-facilities>
                    </li>
                    <li>
                        <p><strong>RECOMMENDATION: </strong></p>
                        <app-retail-recommendation *ngIf="loanHolder && customerAllLoanList"
                                                   [loanDataHolder]="loanHolder"
                                                   [customerAllLoanList]="customerAllLoanList"></app-retail-recommendation>
                    </li>
                    <li>
                        <app-authority-section [loanDataHolder]="loanDataHolder"></app-authority-section>
                    </li>
                    <div>
                        <app-signature-section [loanDataHolder]="loanDataHolder"></app-signature-section>
                    </div>
                </ol>

                <!-- Annex -->
                <div style="page-break-after: always"></div>
                <div class="row">
                    <div class="col-md-12">
                        <app-crg-gamma-detail-view *ngIf="loanDataHolder?.crgGamma"
                                                   [formData]="loanDataHolder?.crgGamma"></app-crg-gamma-detail-view>
                        <div style="page-break-after: always"></div>
                        <app-credit-checklist-view *ngIf="loanDataHolder?.loanHolder?.creditChecklist"
                                                   [formData]="loanDataHolder?.loanHolder?.creditChecklist"
                                                   [fromProfile]="false"
                                                   [customerType]="loanDataHolder?.loanHolder?.customerType"></app-credit-checklist-view>
                    </div>
                </div>
            </div>
            <ng-template #allDocumentView>
                <app-all-document-view *ngIf="loanDataHolder" [loanDataHolder]="loanDataHolder"
                                       [siteVisitDocument]="siteVisitDocuments"></app-all-document-view>
            </ng-template>

        </div>
    </nb-card-body>
</nb-card>

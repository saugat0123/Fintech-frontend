<nb-card>
    <nb-card-header>
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-6">
                    <div class="btn-group">
                        <button
                                (click)="isFilterCollapsed = !isFilterCollapsed"
                                [attr.aria-expanded]="!isFilterCollapsed" aria-controls="searchModel"
                                nbButton
                                shape="rectangle"
                                status="primary">
                            <em class="fa fa-filter"> Filter</em>
                        </button>
                        <nb-toggle (checkedChange)="onChangeTransferToggle($event)"
                                   class="pt-2 pl-4" [disabled]="!transferToggle">
                            Transferred
                        </nb-toggle>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-end">
                    <button nbButton outline status="info"
                            (click)="getCsv()">
                        <i class="fa fa-download" aria-hidden="true"></i></button>
                </div>
            </div>
        </div>

        <div id="searchModel" class="col-md-12" [ngbCollapse]="isFilterCollapsed">
            <form (ngSubmit)="onSearch()" [formGroup]="filterForm">
                <div class="row py-3">
                    <div class="col-md-3 mb-3" *ngIf="accessSpecific || accessAll">
                        <select class="custom-select" formControlName="branch">
                            <option [value]="null" selected hidden>Select Branch</option>
                            <option [value]="null">All Branch</option>
                            <option *ngFor="let branch of branchList" [value]="branch.id">{{branch.name}}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <select class="custom-select" formControlName="loanType">
                            <option [value]="null" selected hidden>Select Loan Type</option>
                            <option [value]="null">All Loan Type</option>
                            <option *ngFor="let loanType of loanTypeList"
                                    [value]="loanType.id">{{loanType.name}}
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3 mb-3">
                        <select class="custom-select" formControlName="docStatus">
                            <option [value]="null" selected hidden>Select Document Status</option>
                            <option [value]="null">All Document Status</option>
                            <option *ngFor="let status of docStatus.values()"
                                    [value]="status">{{status}}
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3 mb-3" *ngIf="accessAll">
                        <select class="custom-select" formControlName="role">
                            <option [value]="null" selected hidden>Select Role</option>
                            <option [value]="null">All Roles</option>
                            <option *ngFor="let role of roleList" [value]="role.id">{{role.roleName}}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <input id="startDate" [nbDatepicker]="startDate" class="form-control rounded"
                               (change)="checkIfDateFiltration()" formControlName="startDate"
                               placeholder="Enter Start Date" [ngClass]="{ 'is-invalid': !validStartDate }">
                        <nb-datepicker #startDate></nb-datepicker>
                        <div *ngIf="!validStartDate" class="invalid-feedback">Invalid start date</div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <input id="endDate" [nbDatepicker]="endDate" class="form-control rounded"
                               (change)="checkIfDateFiltration()" formControlName="endDate"
                               placeholder="Enter End Date" [ngClass]="{ 'is-invalid': !validEndDate }">
                        <nb-datepicker #endDate></nb-datepicker>
                        <div *ngIf="!validEndDate" class="invalid-feedback">Invalid end date</div>
                    </div>


                    <div class="col-md-3 mb-3">
                        <select class="custom-select" formControlName="loanNewRenew">
                            <option [value]="null" selected hidden>Select Type</option>
                            <option [value]="null">All Types</option>
                            <option *ngFor="let status of loanType.values()"
                                    [value]="status">{{loanType[status]}}
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3 mb-3">
                        <input class="form-control rounded" formControlName="customerName" id="customerName"
                               placeholder="Enter customer name">
                    </div>

                    <div class="col-md-3 mb-3">
                        <input class="form-control rounded" formControlName="companyName" id="companyName"
                               placeholder="Enter company name">
                    </div>
                </div>

                <div class="col-md-12 p-0">
                    <button [disabled]="!filterForm.valid" nbButton status="info" shape="rectangle" class="mr-2"
                            type="submit">Search
                    </button>
                    <button (click)="clearSearch()" nbButton shape="rectangle" status="danger" type="button">Clear
                    </button>
                </div>
            </form>
        </div>

    </nb-card-header>
    <nb-card-body>
        <br>
        <table id="add-branch-table" class="table table-bordered table-hover ">
            <thead>
            <tr>
                <th *ngIf="this.showBranch">Branch</th>
                <th>Customer Name</th>
                <th>Loan Facility</th>
                <th>Proposed Amount</th>
                <th>Type</th>
                <th>Status</th>
                <th>Possession Under/Days</th>
                <th>Loan lifespan</th>
                <th *ngIf="transferDoc">Transfer</th>
                <th>Created On</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let model of loanDataHolderList;let i=index"

                class="cursor">
                <td (click)="onClick(model.loan.id,model.id)"
                    *ngIf="this.showBranch">{{model?.branch?.name}}</td>
                <td (click)="onClick(model.loan.id,model.id)">
                    {{model?.loanCategory === 'BUSINESS_TYPE' ?
                    model?.companyInfo?.companyName
                    : model?.customerInfo?.customerName}}</td>
                <td (click)="onClick(model.loan.id,model.id)">{{model?.loan?.name}}</td>
                <td (click)="onClick(model.loan.id,model.id)">
                    <span
                            class="d-flex justify-content-end">{{model?.proposal?.proposedLimit | number}}</span>
                </td>
                <td (click)="onClick(model.loan.id,model.id)">{{loanType[model?.loanType]}}</td>
                <td (click)="onClick(model.loan.id,model.id)">{{model?.documentStatus}}</td>
                <td (click)="onClick(model.loan.id,model.id)">
                    <div *ngIf='model?.documentStatus.toString()==="PENDING" ||
                         model?.documentStatus.toString()==="DOCUMENTATION" ||
                         model?.documentStatus.toString()==="DISCUSSION" ||
                         model?.documentStatus.toString()==="UNDER_REVIEW" ||
                         model?.documentStatus.toString()==="VALUATION"'>
                        {{model?.currentStage?.toUser?.name}}
                        / {{getDifferenceInDays(model?.currentStage?.lastModifiedAt)}}
                    </div>
                    <div *ngIf='(model?.documentStatus.toString()==="CLOSED" ||
                        model?.documentStatus.toString()==="REJECTED" ||
                        model?.documentStatus.toString()==="APPROVED")'>
                        {{model?.currentStage?.toUser?.name}}
                        /{{getDaysDifference(model?.currentStage.lastModifiedAt, model?.previousList[model?.previousList?.length - 1].lastModifiedAt)}}
                    </div>
                </td>
                <td (click)="onClick(model.loan.id,model.id)">
                    <div *ngIf='model?.documentStatus.toString()==="PENDING" ||
                         model?.documentStatus.toString()==="DOCUMENTATION" ||
                         model?.documentStatus.toString()==="DISCUSSION" ||
                         model?.documentStatus.toString()==="UNDER_REVIEW" ||
                         model?.documentStatus.toString()==="VALUATION"'>
                        {{getDifferenceInDays(model?.currentStage?.createdAt)}}</div>
                    <div *ngIf='(model?.documentStatus.toString()==="CLOSED" ||
                        model?.documentStatus.toString()==="REJECTED" ||
                        model?.documentStatus.toString()==="APPROVED")'>
                        {{getDaysDifference(model?.currentStage?.lastModifiedAt, model?.currentStage?.createdAt)}}
                    </div>
                </td>
                <td *ngIf="transferDoc">
                    <button nbButton status="warning" size="small"
                            (click)="onTransferClick(transferDocument,model.id,model?.currentStage?.toUser?.id)">
                        <em class="fa fa-arrow-circle-right"></em></button>
                </td>
                <td>
                    <div (click)="onClick(model.loan.id,model.id)">
                        {{model?.createdAt | date}}
                    </div>
                </td>
                <td class="p-1" *ngIf='statusApproved === true && roleType && !model.isCloseRenew;else linkin'>
                    <select [(ngModel)]="tempLoanType" class="custom-select py-0"
                            (ngModelChange)="onChange(model,onActionChange)">
                        <option [value]="null" selected hidden>Select Type</option>
                        <option value="RENEWED_LOAN">Renew Loan</option>
                        <option value="CLOSURE_LOAN">Close Loan</option>
                        <option value="ENHANCED_LOAN">Enhance Loan</option>
                        <option value="PARTIAL_SETTLEMENT_LOAN">Partial Settle Loan</option>
                        <option value="FULL_SETTLEMENT_LOAN">Full Settle Loan</option>
                    </select>
                </td>
                <ng-template #linkin>
                    <td *ngIf="model.parentId">
                        <a (click)="renewedOrCloseFrom(model.loan.id,model.parentId)"
                           class="text-success cursor">{{loanType[model.loanType]}} From
                            <em class="p-1 fa fa-edit"></em></a>
                    </td>

                    <td *ngIf="!model.parentId">
                        <p>NA</p>
                    </td>
                </ng-template>

            </tr>
            </tbody>
        </table>
        <app-spinner *ngIf="spinner" class="d-flex justify-content-center"></app-spinner>
        <!-- ===================table-pagination==================== -->
        <app-paging *ngIf="!spinner" [pageable]="pageable" (changePage)="changePage($event)"></app-paging>
        <!-- ===================table-pagination==================== -->
    </nb-card-body>

    <ng-template #transferDocument>
        <div class="modal-header">
            <h4 class="modal-title pull-left">Transfer Loan Document</h4>
            <a class="close pull-right cursor" aria-label="Close" (click)="onClose()">
                <span aria-hidden="true">&times;</span>
            </a>
        </div>
        <div class="modal-body">


            <div style="height: 200px;max-height: 200px;overflow-y: auto;">
                <nb-accordion>
                    <nb-accordion-item *ngFor="let roles of transferUserList;let i=index">
                        <nb-accordion-item-header>
                            {{roles.name}}
                        </nb-accordion-item-header>
                        <nb-accordion-item-body>

                            <div *ngFor="let users of roles.userDtoList;let i=index">
                                <div class="col-md-12 row">
                                    <div class="col-md-6">
                                        <a class="cursor">
                                            <div class="radio">
                                                <label><input type="radio" name="optradio"
                                                              (click)="docTransfer(users.id,roles.id)">{{users.username}}
                                                </label>
                                            </div>

                                        </a>
                                    </div>
                                    <div class="col-md-6">

                                        <span *ngFor="let branch of users.branchDtoList;">
                                            {{branch?.name}}
                                        </span>
                                    </div>
                                </div>
                            </div>

                        </nb-accordion-item-body>
                    </nb-accordion-item>
                </nb-accordion>
            </div>
            <div class="col-md-12">
                <button type="submit" class="btn btn-success float-right" (click)="action(confirmation)">Next</button>
            </div>
        </div>
    </ng-template>

    <ng-template #confirmation>
        <div>
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h4 class="">Do You want to transfer this document ?</h4>
                        <form>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-danger  btn-flat fa-pull-left" (click)="onClose()">
                                    NO
                                </button>
                                <button type="submit" class="btn btn-primary  btn-flat" (click)="confirm()">
                                    YES
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </ng-template>

    <ng-template #onActionChange class="modal">
        <div class="modal-header">
            <h5>Do you want to change the loan type to {{loanType[tempLoanType]}}?</h5>
        </div>
        <div class="modal-body">
            <div class="d-flex justify-content-end">
                <button (click)="changeAction()" nbButton status="primary" type="submit">YES</button>
                <button (click)="onClose()" nbButton status="warning" type="button">NO</button>
            </div>
        </div>
    </ng-template>
</nb-card>

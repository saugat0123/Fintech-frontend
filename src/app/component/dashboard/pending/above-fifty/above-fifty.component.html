<div class="row">
    <div class="col-md-12">
        <nb-card >
            <nb-card-header>
            </nb-card-header>
            <nb-card-body>
                <div class="box-body">
                    <table class="table table-sm sb-small table-bordered table-hover text-center">
                        <thead>
                        <tr class="sb-bg-dark text-white">
                            <th>S.N</th>
                            <th>Branch</th>
                            <th>Branch Province</th>
                            <th>Customer Name</th>
                            <th>Customer Code</th>
                            <th>Customer Type</th>
                            <th>Contact Number</th>
                            <th>Total Single Proposal</th>
                            <th>Total Combined Proposal</th>
                            <th>Total Loan</th>
                            <th>Detail</th>
                        </tr>
                        </thead>
                        <tbody>
                        <ng-container *ngFor="let loanHolderLoans of loanHolderLoanList; let i =index">
                            <tr class="cursor">
                                <td>{{i + 1}}</td>
                                <td>{{loanHolderLoans?.ci?.branch?.name}}</td>
                                <td>{{loanHolderLoans?.ci?.branch?.province?.name}}</td>
                                <td>{{loanHolderLoans?.ci?.name}}</td>
                                <td>{{loanHolderLoans?.ci?.customerCode || '-'}}</td>
                                <td>{{loanHolderLoans?.ci?.customerType}}</td>
                                <td>{{loanHolderLoans?.ci?.contactNo || '-'}}</td>
                                <td>
                                    <ng-container *ngFor="let singleLoan of loanHolderLoans?.loanSingleList">
                                        Rs. <span
                                            [ngStyle]="{ 'color' : (singleLoan?.proposal?.proposedLimit < 50000000)? '#e16c00': '#0fa002'}">
                                            {{singleLoan?.proposal?.proposedLimit}}
                                        </span>
                                    </ng-container>
                                </td>
                                <td>
                                    <ng-container *ngFor="let item of loanHolderLoans?.combineList[0] | keyvalue">
                                        Rs. <span [ngStyle]="{ 'color' : (totalCombinedProposed(item?.value) > 50000000)? '#0fa002': '#e16c00'}">
                                        {{totalCombinedProposed(item?.value)}}</span>
                                    </ng-container>
                                </td>
                                <td>{{loanHolderLoans?.totalLoan}}</td>
                                <td>
                                    <a class="px-2 cursor"
                                       (click)="loanHolderLoans?.ci?.id ? toggleArray[i].toggled = !toggleArray[i].toggled:''"
                                       nbTooltip="click to view detail Loan Data ">
                                        <em class="fa fa-eye"></em>
                                    </a></td>
                            </tr>
                            <ng-container *ngIf="toggleArray[i].toggled">
                                <tr>
                                    <td colspan="10"><b>Customer Loan Detail</b></td>
                                </tr>
                                <tr class="sb-bg-dark text-white">
                                    <td>Loan Facility</td>
                                    <td>Proposed Amount</td>
                                    <td>Loan Type</td>
                                    <td>Status</td>
                                    <td>Current Possession</td>
                                    <td>Received On</td>
                                    <th>Comment History</th>
                                </tr>
                                <tr *ngFor="let l of loanHolderLoans?.loanSingleList"
                                >
                                    <td (click)="onClick(l.loan.id,l.id, l?.customerInfo?.id)"
                                        class="cursor"
                                        nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline">{{l?.loan?.name}}</td>
                                    <td (click)="onClick(l.loan.id,l.id, l?.customerInfo?.id)" nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline"
                                        class="d-flex justify-content-end pr-1">Rs .{{l?.proposal?.proposedLimit }}</td>
                                    <td (click)="onClick(l.loan.id,l.id, l?.customerInfo?.id)" class="cursor"
                                        nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline">{{l?.loanType}}</td>

                                    <td (click)="onClick(l.loan.id,l.id, l?.customerInfo?.id)" class="cursor"
                                        nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline">{{l?.documentStatus}}</td>
                                    <td (click)="onClick(l.loan.id,l.id, l?.customerInfo?.id)" class="cursor"
                                        nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline">{{l?.currentStage?.toUser?.name}}</td>
                                    <td (click)="onClick(l.loan.id,l.id, l?.customerInfo?.id)"><span *ngIf="l?.previousList.length > 0">
                                   {{l?.currentStage?.lastModifiedAt | date}}
                                    </span></td>
                                    <td>
                                        <i class="fas fa-eye" (click)="openCommentModal(commentModal,l)"
                                           nbTooltipStatus="control"
                                           nbTooltipIcon="info-outline"
                                           nbTooltip="Click to see Loan History"></i>
                                    </td>
                                </tr>
                                <tr *ngFor="let l of loanForCombine[i].loan;let x = index"
                                    class="cursor"
                                >
                                    <td nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline"
                                        (click)="combineLoanListDisplay(l,combineListTemplate,i, loanForCombine[i]?.customerInfoId)">{{l?.loan?.name}}</td>
                                    <td nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline"
                                        (click)="onClick(l.loan.id,l.id, loanForCombine[i]?.customerInfoId)"
                                        class="d-flex justify-content-end pr-1">Rs .{{l?.proposal?.proposedLimit}}</td>
                                    <td (click)="onClick(l.loan.id,l.id, loanForCombine[i]?.customerInfoId)"
                                        class="cursor"
                                        nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline">{{l?.loanType}}</td>

                                    <td nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline"
                                        (click)="onClick(l.loan.id,l.id, loanForCombine[i]?.customerInfoId)">{{l?.documentStatus}}</td>
                                    <td nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline"
                                        (click)="onClick(l.loan.id,l.id, loanForCombine[i]?.customerInfoId)">{{l?.currentStage?.toUser?.name}}</td>
                                    <td nbTooltip="Click to View Detail"
                                        nbTooltipStatus="control"
                                        nbTooltipIcon="question-mark-circle-outline" (click)="onClick(l.loan.id,l.id, loanForCombine[i]?.customerInfoId)"> <span
                                            *ngIf="l?.previousList.length > 0">
                                   {{l?.currentStage?.lastModifiedAt | date}}
                                    </span></td>
                                    <td>
                                        <i class="fas fa-eye" (click)="openCommentModal(commentModal,l)"
                                           nbTooltipStatus="control"
                                           nbTooltipIcon="info-outline"
                                           nbTooltip="Click to see Loan History"></i>
                                    </td>
                                </tr>

                                <tr>
                                    <td colspan="10"><b>.</b></td>
                                </tr>

                            </ng-container>


                        </ng-container>
                        </tbody>
                    </table>
                </div>
<!--                <app-paging (changePage)="changePage($event)"-->
<!--                            [pageable]="pageable"></app-paging>-->
            </nb-card-body>
        </nb-card>
    </div>
</div>
<ng-template #commentModal>
    <div class="card">
        <div class="card-header">
            <div class="clearfix">
                <div class="float-left">Loan Activity</div>
                <div class="float-right"><a class="close pull-right cursor" aria-label="Close" (click)="onClose()">
                    <span aria-hidden="true">&times;</span>
                </a></div>
            </div>
        </div>
    </div>
    <div class="card-body">

        <table class="table table-sm sb-small table-bordered table-hover text-center">
            <thead>
            <tr class="sb-bg-dark text-white">
                <th>Date</th>
                <th>From User</th>
                <th>To User</th>
                <th>Action</th>
                <th colspan="6">Comment</th>
            </tr>
            </thead>
            <tr *ngFor="let previous of model?.previousList">
                <td>{{previous?.lastModifiedAt | date:'medium'}}</td>
                <td>{{previous?.fromUser?.name}}</td>
                <td>{{previous?.toUser.name}}</td>
                <td>{{previous?.docAction?.toString() === 'BACKWARD_TO_COMMITTEE' ? 'FOWARD TO COMMITTEE'
                    : previous?.docAction}}</td>
                <td colspan="6"><span [innerHTML]="customSafePipe(previous.comment)"></span></td>
            </tr>
            <tr>
                <td>{{model?.currentStage?.lastModifiedAt | date:'medium'}}</td>
                <td>{{model?.currentStage?.fromUser?.name}}</td>
                <td>{{model?.currentStage?.toUser.name}}</td>
                <td>{{model?.currentStage?.docAction?.toString() === 'BACKWARD_TO_COMMITTEE' ? 'FOWARD TO COMMITTEE'
                    : model?.currentStage?.docAction}}</td>
                <td colspan="6"><span [innerHTML]="customSafePipe(model?.currentStage?.comment)"></span></td>
            </tr>
            <tr>
                <td colspan="12" class="sb-bg-dark">.</td>
            </tr>
        </table>

    </div>
</ng-template>

<ng-template #combineListTemplate>
    <span class="text-center"><strong>Loan</strong></span>
    <div class="modal-header">
        <div class="modal-body">
            <table class="table table-sm sb-small table-bordered table-hover text-center">
                <thead>
                <tr class="sb-bg-dark text-white">
                    <td>Loan Facility</td>
                    <td>Proposed Amount</td>
                    <td>Loan Type</td>
                    <td>Status</td>

                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let l of displayCombineLoanList?.loanData;" class="cursor">
                    <td nbTooltip="Click to View Detail"
                        nbTooltipStatus="control"
                        nbTooltipIcon="question-mark-circle-outline"
                        (click)="onClickLoan(l?.loan?.id,l?.id, displayCombineLoanList?.customerInfoId)">{{l?.loan?.name}}</td>
                    <td nbTooltip="Click to View Detail"
                        nbTooltipStatus="control"
                        nbTooltipIcon="question-mark-circle-outline" (click)="onClick(l.loan.id,l.id, displayCombineLoanList?.customerInfoId)"
                        class="d-flex justify-content-end pr-1">Rs .{{l?.proposal?.proposedLimit}}</td>
                    <td (click)="onClickLoan(l.loan.id,l.id, displayCombineLoanList?.customerInfoId)" class="cursor"
                        nbTooltip="Click to View Detail"
                        nbTooltipStatus="control"
                        nbTooltipIcon="question-mark-circle-outline">{{l?.loanType}}</td>

                    <td nbTooltip="Click to View Detail"
                        nbTooltipStatus="control"
                        nbTooltipIcon="question-mark-circle-outline"
                        (click)="onClickLoan(l.loan.id,l.id, displayCombineLoanList?.customerInfoId)">{{l?.documentStatus}}</td>
                    <!--                    <ng-container *ngFor="let l of lo?.loanData">-->
                    <!--                        -->
                    <!--                    </ng-container>-->
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</ng-template>
<app-overlay-spinner></app-overlay-spinner>
